"use strict";(globalThis["webpackChunkastral"]=globalThis["webpackChunkastral"]||[]).push([[255],{4255:(e,t,s)=>{s.r(t),s.d(t,{default:()=>E});s(40702);var a=s(59835),r=s(86970),i=s(61957);const l=e=>((0,a.dD)("data-v-6885ccce"),e=e(),(0,a.Cn)(),e),n=l((()=>(0,a._)("div",{id:"header-placeholder"},null,-1))),o={id:"header",ref:"header"},d={class:"flex row justify-evenly no-wrap full-width q-pt-sm q-px-sm"},c={class:"relative-position"},u={class:"absolute-top flex justify-center"},h={class:"text-accent z-top q-px-sm",style:{},id:"current-datestamp"},p={key:0,class:"row justify-center q-my-md"},m=l((()=>(0,a._)("div",{style:{height:".5rem"}},null,-1))),g={class:"full-width relative-position q-pt-xs"},y={class:"gt-xs"};function b(e,t,s,l,b,k){const v=(0,a.up)("BaseUserCard"),f=(0,a.up)("q-separator"),w=(0,a.up)("BaseMessage"),M=(0,a.up)("q-spinner-orbit"),x=(0,a.up)("q-infinite-scroll"),S=(0,a.up)("q-btn"),_=(0,a.up)("BasePostEntry"),q=(0,a.up)("q-page"),P=(0,a.Q2)("scroll-fire");return(0,a.wg)(),(0,a.j4)(q,{class:"flex column no-wrap",style:{"min-height":"100vh"}},{default:(0,a.w5)((()=>[n,(0,a._)("div",o,[(0,a._)("div",d,[k.hexPubkey?((0,a.wg)(),(0,a.j4)(v,{key:0,pubkey:k.hexPubkey,"action-buttons":!1,style:{width:"50%"}},null,8,["pubkey"])):(0,a.kq)("",!0),e.$store.state.keys.pub?((0,a.wg)(),(0,a.j4)(v,{key:1,pubkey:e.$store.state.keys.pub,"action-buttons":!1,"align-right":!0,style:{width:"50%","self-justify":"end"}},null,8,["pubkey"])):(0,a.kq)("",!0)]),(0,a.Wm)(f,{color:"accent",size:"1px",spaced:""}),(0,a._)("div",c,[(0,a._)("div",u,[(0,a._)("span",h,(0,r.zw)(b.currentDatestamp),1)])])],512),(0,a._)("div",{ref:"messageScroll",id:"message-scroll",onScroll:t[0]||(t[0]=(...e)=>k.updateCurrentDatestamp&&k.updateCurrentDatestamp(...e)),onTouchmove:t[1]||(t[1]=(...e)=>k.updateCurrentDatestamp&&k.updateCurrentDatestamp(...e)),onTouchend:t[2]||(t[2]=(...e)=>k.delayedUpdateCurrentDatestamp&&k.delayedUpdateCurrentDatestamp(...e))},[(0,a.Wm)(x,{onLoad:k.loadMore,reverse:"",ref:"messagesScroll"},{loading:(0,a.w5)((()=>[b.canLoadMore?((0,a.wg)(),(0,a.iD)("div",p,[(0,a.Wm)(M,{color:"accent",size:"md"})])):(0,a.kq)("",!0)])),default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(k.messagesGrouped,((t,s)=>{var i;return(0,a.wg)(),(0,a.iD)("div",{key:t.id+"_"+(null===(i=t.taggedEvents)||void 0===i?void 0:i.length),class:"flex column items-self"},[0===s||e.dateUTC(k.messagesGrouped[s].created_at)!==e.dateUTC(k.messagesGrouped[s-1].created_at)?((0,a.wg)(),(0,a.iD)("div",{key:0,class:(0,r.C_)(["self-center text-accent datestamp",0===s?"q-pb-sm":"q-py-sm"])},(0,r.zw)(e.dateUTC(t.created_at)),3)):(0,a.kq)("",!0),(0,a.wy)((0,a.Wm)(w,{id:t.id,event:t,onMounted:k.scrollToBottom,onReply:k.reply},null,8,["id","event","onMounted","onReply"]),[[P,k.markAsRead]])])})),128)),m])),_:1},8,["onLoad"])],544),(0,a._)("div",g,[b.unreadMessagesSet.size?((0,a.wg)(),(0,a.j4)(S,{key:0,label:b.unreadMessagesSet.size+" unread","icon-right":"mail_lock",color:"secondary",class:"q-ma-sm unread-messages-button",outline:"",size:"sm",onClick:t[3]||(t[3]=(0,i.iM)((e=>k.scrollToBottom()),["stop"]))},null,8,["label"])):(0,a.kq)("",!0),(0,a._)("div",y,[(0,a.Wm)(f,{color:"accent",size:"1px"}),(0,a.Wm)(_,{"message-mode":k.messageMode,event:b.replyEvent,onClearEvent:t[4]||(t[4]=e=>b.replyEvent=null),onSent:k.addSentMessage,class:"q-px-md q-pt-sm"},null,8,["message-mode","event","onSent"])])])])),_:1})}s(46727);var k=s(18933),v=s(34136),f=s(31244),w=s(19302),M=s(31020),x=s(22330);const S={title:"astral - messages",meta:{description:{name:"description",content:`Nostr messages with ${window.location.pathname.split("/")[2]}`},keywords:{name:"keywords",content:"nostr decentralized social media"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}},_={name:"Messages",mixins:[k.Z,(0,M.Z)(S)],emits:["reply-event","scroll-to-rect"],components:{BaseMessage:f.Z},setup(){const e=(0,w.Z)();return e},data(){return{sub:{},messages:[],canLoadMore:!0,text:"",messagesSet:new Set,unreadMessagesSet:new Set,unlock:()=>{},mutex:null,replyEvent:null,currentDatestamp:null}},computed:{messageMode(){return"messages"===this.$route.name?this.replyEvent?"reply":"message":null},hexPubkey(){return this.$route.params.pubkey?this.bech32ToHex(this.$route.params.pubkey):""},messagesGrouped(){let e=this.messages.reduce(((e,t)=>{let s=Object.assign({},t);if(!e.length)return[s];let a=e[e.length-1];return a.pubkey===s.pubkey&&a.created_at+120>=s.created_at?(a.appended=a.appended||[],a.appended.push(s)):e.push(s),e}),[]);return e}},async mounted(){await this.start(),this.scrollToBottom(),this.resizeHeaderPlaceholder()},async beforeUnmount(){this.sub.listenMessages&&this.sub.listenMessages.cancel(),this.sub.streamUserProfile&&this.sub.streamUserProfile.cancel()},methods:{async lock(){this.mutex&&await this.mutex,this.mutex=new Promise((e=>{this.unlock=e}))},async start(){let e=await(0,v.NL)(this.hexPubkey);if(e){let t=(0,x.Wb)(e);this.$store.commit("addProfileToCache",t),this.$store.dispatch("useNip05",{metadata:t})}this.sub.streamUserProfile=await(0,v.ix)(this.hexPubkey,(async e=>{let t=(0,x.Wb)(e);this.$store.commit("addProfileToCache",t),this.$store.dispatch("useNip05",{metadata:t})})),this.sub.listenMessages=await(0,v.Qg)((async e=>{let t=e.tags.filter((([e,t])=>"p"===e&&t)).map((([e,t])=>t));(e.pubkey===this.hexPubkey&&t.includes(this.$store.state.keys.pub)||e.pubkey===this.$store.state.keys.pub&&t.includes(this.hexPubkey))&&this.addMessage(e)})),this.$store.commit("haveReadMessage",this.hexPubkey)},async scrollToBottom(){return new Promise((e=>setTimeout((()=>{this.$refs.messageScroll.scrollTop=this.$refs.messageScroll.scrollHeight,this.$emit("scroll-to-rect",{top:this.$refs.messageScroll.scrollHeight}),this.$store.commit("haveReadMessage",this.hexPubkey),this.unreadMessagesSet.clear(),e()}),100)))},async loadMore(e,t){var s;let a=await(0,v.Uk)(this.$store.state.keys.pub,this.hexPubkey,50,(null===(s=this.messages[0])||void 0===s?void 0:s.created_at)-1||Math.round(Date.now()/1e3));a.length<50&&(this.canLoadMore=!1);let r=await this.processMessages(a);this.messages=r.concat(this.messages),this.messages.sort(((e,t)=>e.created_at-t.created_at)),t(!this.canLoadMore)},async processMessages(e){let t=[];for(let s=0;s<e.length;s++){let a=e[s];this.messagesSet.has(a.id)||(this.messagesSet.add(a.id),await this.lock(),a.text=await this.getPlaintext(a),this.unlock(),this.interpolateMessageMentions(a),t.push(a))}return t},markAsRead(e){0!==this.unreadMessagesSet.size&&this.unreadMessagesSet.has(e.id)&&(this.unreadMessagesSet.delete(e.id),0===this.unreadMessagesSet.size&&this.$store.commit("haveReadMessage",this.hexPubkey))},reply(e){this.replyEvent=null,setTimeout((()=>{let t=Object.assign({},e);t.appended=[],this.replyEvent=t,this.$emit("reply-event",this.replyEvent)}),20)},updateCurrentDatestamp(e){let t=this.$refs.messageScroll,s=Array.from(t.querySelectorAll(".datestamp")),a=document.querySelector("#header").clientHeight,r=s.reduce(((e,t)=>{let s=t.getBoundingClientRect();return s.top<a&&t.offsetTop>e.offsetTop?t:e}),s[0]);this.currentDatestamp=r.innerText},delayedUpdateCurrentDatestamp(e){let t=0,s=setInterval((()=>{this.updateCurrentDatestamp(),t++,t>9&&clearInterval(s)}),100)},async addMessage(e){let t=this.$refs.messageScroll,s=100>Math.abs(t.scrollHeight-t.clientHeight-t.scrollTop)||t.scrollHeight===t.clientHeight,a=await this.processMessages([e]);if(!a.length)return;let r=a[0];this.messages.push(r),this.messages.sort(((e,t)=>e.created_at-t.created_at)),s?(this.$store.commit("haveReadMessage",this.hexPubkey),this.scrollToBottom()):r.pubkey===this.hexPubkey&&this.unreadMessagesSet.add(r.id)},addSentMessage(e){this.addMessage(e),this.replyEvent=null},resizeHeaderPlaceholder(){setTimeout((()=>{document.querySelector("#header-placeholder").style.minHeight=`${document.querySelector("#header").clientHeight}px`}),1e3)}}};var q=s(11639),P=s(69885),T=s(50926),$=s(86870),C=s(10786),D=s(24455),z=s(27350),H=s(69984),U=s.n(H);const B=(0,q.Z)(_,[["render",b],["__scopeId","data-v-6885ccce"]]),E=B;U()(_,"components",{QPage:P.Z,QSeparator:T.Z,QInfiniteScroll:$.Z,QSpinnerOrbit:C.Z,QBtn:D.Z}),U()(_,"directives",{ScrollFire:z.Z})}}]);